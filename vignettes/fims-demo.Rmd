---
title: "FIMS Demo"
output: github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fisheries Integrated Modeling System
The NOAA Fisheries Integrated Modeling System (FIMS) is a new modeling framework for fisheries modeling. FIMS is a software system designed and architected to support next-generation fisheries stock assessment, ecosystem, and socioeconomic modeling. It's important to note that FIMS itself is not a model, but rather a framework for creating models. The framework is made up of many modules that come together to create a "the best model" that suites the needs of the end-user. What follows is a demo of creating an assessment model using FIMS.

## Creating Models in FIMS
To begin, we import the FIMS library and define some important variables that describe the dimensions of our data.
```{r fims1}
library(FIMS)

fims <- Rcpp::Module("fims", PACKAGE = "FIMS")

nyears<-30  # the number of years which we have data for.
nseanons<-1 # the number of seasons in each year.
ages<-c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)   # age vector.
nages<-12   # the number of age groups.

```


## Creating a Population
Each module in the FIMS-R interface is made of S4 objects. These S4 objects serve as a interface between R and the underlining C++ code that defines FIMS. Let's now define a population.

### Recruitment
We'll start with a recruitment module.

```{r recruitment}
# Recruitment
recruitment <- new(fims$BevertonHoltRecruitment)
recruitment$log_sigma_recruit$value <- log(0.4)
recruitment$log_rzero$value <- log(1e+06)
recruitment$log_rzero$is_random_effect <- FALSE
recruitment$log_rzero$estimated <- TRUE
recruitment$logit_steep$value <- -log(1.0 - 0.75) + log(0.75 - 0.2)
recruitment$logit_steep$is_random_effect <- FALSE
recruitment$logit_steep$estimated <- FALSE
recruitment$estimate_deviations <- FALSE
recruitment$deviations <- rep(0.01,30)

```
### Growth
Now, we'll define the growth module for our population using an emprical weight at age model.
```{r growth}
# Growth
ewaa_growth <- new(fims$EWAAgrowth)
ewaa_growth$ages <- ages
ewaa_growth$weights <- c(0.5306555, 1.1963283, 2.0582654, 
                         3.0349873, 4.0552124, 5.0646975,
                         6.0262262, 6.9169206,  7.7248909, 
                         8.4461128, 9.0818532, 9.6366950)

```   
### Maturity
Each population will also need a maturity model. Here we define a logistic maturity model. 
```{r maturity}
# Maturity
maturity <- new(fims$LogisticMaturity)
maturity$median$value <- 2.25
maturity$median$is_random_effect <- FALSE
maturity$median$estimated <- FALSE
maturity$slope$value <- 3
maturity$slope$is_random_effect <- FALSE
maturity$slope$estimated <- FALSE
```

Now that our life history sub-models are defined, lets define the actual population.

```{r population}
# Population
population <- new(fims$Population)
population$log_M <- rep(log(0.2), nages)
population$log_init_naa <- log(c(993947.5,811707.8, 661434.4, 
                                 537804.8, 436664.0, 354303.4, 
                                 287397.0, 233100.2, 189054.0, 
                                 153328.4, 124353.2, 533681.3))
population$estimate_init_naa <- TRUE
population$nages <- nages
population$ages <- ages
population$nfleets <- 1
population$nseasons <- 1
population$nyears <- nyears
population$SetMaturity(maturity$get_id())
population$SetGrowth(ewaa_growth$get_id())
population$SetRecruitment(recruitment$get_id())

```

## Creating a Fleet
### Selectivity
### Adding Data
## Creating a Survey
### Selectivity
### Adding Data
## Putting It All Together 
## Creating a TMB Model
## Fitting the Model


